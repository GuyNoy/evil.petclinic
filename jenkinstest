node {

stage('Clone repository') {
 checkout scm       

    }

   
    stage('Download latest twistcli') {
            withCredentials([usernamePassword(credentialsId: 'twistlock_creds', passwordVariable: 'TL_PASS', usernameVariable: 'TL_USER')]) {
            sh 'curl -k -u $TL_USER:$TL_PASS --output ./twistcli https://$TL_CONSOLE/api/v1/util/twistcli'
            sh 'sudo chmod a+x ./twistcli'
        }
    }

    stage('Check image Git dependencies has no vulnerabilities') {
    echo 'before scanning'
     withCredentials([usernamePassword(credentialsId: 'twistlock_creds', passwordVariable: 'TL_PASS', usernameVariable: 'TL_USER')]) {
     prismaCloudScanCode excludedPaths: '', explicitFiles: '', logLevel: 'info', pythonVersion: '', repositoryName: 'https://github.com/rbenavente/evil.petclinic', repositoryPath: '.', resultsFile: 'prisma-cloud-scan-results.json'
     prismaCloudPublish resultsFilePattern: 'prisma-cloud-scan-results.json'
     sh "./twistcli coderepo scan --u $TL_USER --p $TL_PASS --address https://$TL_CONSOLE  . --details "
                 }
    echo 'after  scanning'
       
        }
    
    }
  
